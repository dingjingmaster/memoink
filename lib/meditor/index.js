"use strict";import "../prism/base.js";import "../marked/index.js";import addon from "./addon/base.js";importCss("/css/meditor.css");const LANGUAGES={en:{NAME:"Open Source Markdown Editor",TOOLBAR:{PIPE:"",H1:"Header",QUOTE:"Quote text",BOLD:"Font-bold",ITALIC:"Font-italic",THROUGH:"Font-through",UNORDERED:"Unordered list",ORDERED:"Ordered list",LINK:"Hyperlink",HR:"Line",TIME:"Insert current time",FACE:"Face",TABLE:"Insert table",IMAGE:"Upload Pictures",FILE:"Upload Files",INLINECODE:"Inline code",BLOCKCODE:"Block code",PREVIEW:"Preview",FULLSCREEN:"Fullscreen",ABOUT:"About MEditor"},HEADERS:{H1:"#{1}",H2:"#{2}",H3:"#{3}",H4:"#{4}",H5:"#{5}",H6:"#{6}"},PLACEHOLDER:"Type here",LINK:{ALT:"Link text",URL:"Link address",ERROR:"Link address and text can not be null"},IMAGE:{ALT:"Image alt text",URL:"Image address"},TARGET:{BLANK:"New window open",SELF:"Current window open"},BTN:{YES:"OK"},TABLE:{ROW:"row",COLUMN:"column",THEAD:"thead"},LAYER:{FACE_TITLE:"Insert Face",ABOUT_TITLE:"About MEditor"},CODE:{OTHER:"Other language"}},zh:{NAME:"开源在线Markdown编辑器",TOOLBAR:{PIPE:"",H1:"标题",QUOTE:"引用文本",BOLD:"粗体",ITALIC:"斜体",THROUGH:"删除线",UNORDERED:"无序列表",ORDERED:"有序列表",LINK:"超链接",HR:"横线",TIME:"插入当前时间",FACE:"表情",TABLE:"插入表格",IMAGE:"插入图片",FILE:"插入附件",INLINECODE:"行内代码",BLOCKCODE:"代码块",PREVIEW:"预览",FULLSCREEN:"全屏",ABOUT:"关于编辑器"},HEADERS:{H1:"一级标题",H2:"二级标题",H3:"三级标题",H4:"四级标题",H5:"五级标题",H6:"六级标题"},PLACEHOLDER:"在此输入文本",LINK:{ALT:"链接文字",URL:"链接地址",ERROR:"链接文字和地址不能为空"},IMAGE:{ALT:"图片描述",URL:"图片地址"},TARGET:{BLANK:"新窗口打开",SELF:"本窗口打开"},BTN:{YES:"确定"},TABLE:{ROW:"行",COLUMN:"列",THEAD:"表头"},LAYER:{FACE_TITLE:"插入表情",ABOUT_TITLE:"关于编辑器"},CODE:{OTHER:"其他语言"}}};LANGUAGES["zh-CN"]=LANGUAGES.zh,LANGUAGES["zh-TW"]=LANGUAGES.zh;const lang=LANGUAGES[window.__ENV_LANG__||navigator.language]||LANGUAGES.en;marked.setOptions({highlight:function(e,t){return Prism.highlight(e,Prism.languages[t])}}),String.prototype.repeat||(String.prototype.repeat=function(e){let t="";for(;e>0;)t+=this,e--;return t}),Anot.ui.meditor={version:"1.0.0",author:"yutent",lang:lang};const log=console.log,DEFAULT_TOOLBAR=["h1","quote","|","bold","italic","through","|","unordered","ordered","|","hr","link","time","face","|","table","image","attach","inlinecode","blockcode","|","preview","fullscreen","|","about"],ELEMS={a:function(e,t,n){let i=t.match(attrExp("href")),r=t.match(attrExp("title")),l=t.match(attrExp("target")),o="";return i=i&&i[1]||null,r=r&&r[1]||null,l=l&&l[1]||"_self",i?(i=i.replace("viod(0)",""),o=`target=${l}`,o+=r?`;title=${r}`:"",`[${n||i}](${i} "${o}")`):n||i},em:function(e,t,n){return n&&"_"+n+"_"||""},strong:function(e,t,n){return n&&"**"+n+"**"||""},pre:function(e,t,n){return"\n\n```\n"+(n=n.replace(/<[/]?code>/g,""))+"\n```\n"},code:function(e,t,n){return n&&"`"+n+"`"||""},blockquote:function(e,t,n){return"> "+n.trim()},img:function(e,t,n){var i=t.match(attrExp("src")),r=t.match(attrExp("alt"));return i=i&&i[1]||"","!["+(r=r&&r[1]||"")+"]("+i+")"},p:function(e,t,n){return n?"\n"+n:""},br:"\n","h([1-6])":function(e,t,n,i){return"\n"+"#".repeat(t)+" "+i+"\n"},hr:"\n\n___\n\n"};function attrExp(e,t="i"){return new RegExp(e+"\\s?=\\s?[\"']?([^\"']*)[\"']?",t)}function tagExp(e,t){var n="";return n=["br","hr","img"].indexOf(e)>-1?"<"+e+"([^>]*?)\\/?>":"<"+e+"([^>]*?)>([\\s\\S]*?)<\\/"+e+">",new RegExp(n,"gi")}function html2md(e){try{e=decodeURIComponent(e)}catch(e){}e=e.replace(/\t/g,"  ").replace(/<meta [^>]*>/,"").replace(attrExp("class","g"),"").replace(attrExp("style","g"),"").replace(/<(?!a |img )(\w+) [^>]*>/g,"<$1>").replace(/<svg[^>]*>.*?<\/svg>/g,"{invalid image}");for(let t in ELEMS){let n=ELEMS[t],i=tagExp(t);if("blockquote"===t)for(;e.match(i);)e=e.replace(i,n);else e=e.replace(i,n);"p"===t&&(i=tagExp("div"),e=e.replace(i,n)),"em"===t&&(i=tagExp("i"),e=e.replace(i,n)),"strong"===t&&(i=tagExp("b"),e=e.replace(i,n))}let t=/<(ul|ol)>(?:(?!<ul|<ol)[\s\S])*?<\/\1>/gi;for(;e.match(t);)e=e.replace(t,function(e){return"\n"+(e=e.replace(/<(ul|ol)>([\s\S]*?)<\/\1>/gi,function(e,t,n){let i=n.split("</li>");i.pop();for(let e=0,n=i.length;e<n;e++){let n="ol"===t?e+1+". ":"* ";i[e]=n+i[e].replace(/\s*<li>([\s\S]*)/i,function(e,t){return t=t.trim().replace(/\n/g,"\n  ")}).replace(/<[\/]?[\w]*[^>]*>/g,"")}return i.join("\n")})).trim()});return e=e.replace(/<[\/]?[\w]*[^>]*>/g,"").replace(/```([\w\W]*)```/g,function(e,t){return"```"+(t=t.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">"))+"```"})}function tool(e){e="|"===(e=(e+"").trim().toLowerCase())?"pipe":e;let t=lang.TOOLBAR[e.toUpperCase()],n="";switch(e){case"preview":n=':class="{active: preview}"';break;case"fullscreen":n=':class="{active: fullscreen}"'}return`\n  <span title="${t}" class="do-meditor__icon icon-${e}" data-name="${e}" ${n}></span>`}class MEObject{constructor(e){this.vm=e,this.id=e.$id}getVal(){return this.vm.value.trim()}getHtml(){return this.vm.__tmp__}setVal(e){this.vm.value=e||""}}Anot.component("meditor",{__init__:function(e,t,n){this.classList.add("do-meditor"),this.setAttribute(":css","{height: height}"),this.setAttribute(":class","{fullscreen: fullscreen, preview: preview, disabled: disabled}"),e.hasOwnProperty("disabled")&&(t.disabled=!0,delete e.disabled),e.height&&((isFinite(e.height)&&e.height>180||/%$/.test(e.height))&&(t.height=e.height),delete e.height),n()},render:function(){let e=(this.props.toolbar||DEFAULT_TOOLBAR).map(e=>tool(e)).join("");return delete this.props.toolbar,`\n    <div class="tool-bar do-fn-noselect" :click="onToolClick">${e}</div>\n    <textarea \n      ref="editor"\n      class="editor-body" \n      spellcheck="false" \n      :attr="{disabled: disabled}"\n      :css="{'padding-bottom': padding}"\n      :duplex="value"></textarea>\n    <content\n      ref="preview"\n      class="md-preview do-marked-theme" \n      :css="{'padding-bottom': padding}"\n      :visible="preview" \n      :html="htmlTxt"></content>\n    `},componentDidMount:function(e,t){let n=Anot(this.$refs.editor),i=this.$refs.preview;n.bind("keydown",e=>{let t=this.selection()||"",n=!!t;9===e.keyCode&&(e.preventDefault(),t=t.split("\n").map(function(t){return e.shiftKey?t.replace(/^\s\s/,""):"  "+t}).join("\n"),this.insert(t,n)),8===e.keyCode&&n&&(e.preventDefault(),this.insert("",n))}),n.bind("paste",e=>{e.preventDefault();let t=e.clipboardData.getData("text/plain").trim(),n=e.clipboardData.getData("text/html").trim();(n=html2md(n))?this.insert(n):t&&this.insert(t),this.value=this.$refs.editor.value}),n.bind("scroll",e=>{let t=e.target.scrollTop,n=e.target.scrollHeight,r=e.target.clientHeight,l=t/(n-r)*(i.scrollHeight-r);i.scrollTop=l}),"function"==typeof this.props.created&&this.props.created(new MEObject(this)),this.padding=this.$elem.clientHeight/2>>>0,this.compile(),this.preview&&(this.htmlTxt=this.__tmp__)},watch:{value:function(e){this.compile(),this.preview&&(this.htmlTxt=this.__tmp__),"function"==typeof this.props.onUpdate&&this.props.onUpdate(this.value,this.__tmp__)}},state:{padding:90,height:180,disabled:!1,fullscreen:!1,preview:window.innerWidth>768,htmlTxt:"",value:"",addon:addon},props:{safeMode:!0,revise:Anot.PropsTypes.isFunction(),created:Anot.PropsTypes.isFunction(),onUpdate:Anot.PropsTypes.isFunction(),onFullscreen:Anot.PropsTypes.isFunction()},skip:["addon","insert","selection"],methods:{insert(e,t){let n=this.$refs.editor;if(document.selection){n.focus();let t=document.selection.createRange();t.text=e,n.focus(),t.moveStart("character",-1)}else if(n.selectionStart||0===n.selectionStart){let i=n.selectionStart,r=n.selectionEnd,l=n.scrollTop;n.value=n.value.slice(0,i)+e+n.value.slice(r,n.value.length),n.selectionStart=t?i:i+e.length,n.selectionEnd=i+e.length,n.scrollTop=l,n.focus()}else n.value+=e,n.focus();this.value=n.value},selection(e){let t=this.$refs.editor;if(document.selection)return document.selection.createRange().text;{let n=t.selectionStart,i=t.selectionEnd;if(i){if(e){n=t.value.slice(0,n).lastIndexOf("\n");let e=t.value.slice(i).indexOf("\n");e=e<0?t.value.slice(i).length:e,n+=1,i+=e,t.selectionStart=n,t.selectionEnd=i}}else e&&(i=(i=t.value.indexOf("\n"))<0?t.value.length:i,t.selectionEnd=i);return t.focus(),t.value.slice(n,i)}},onToolClick:function(e){if("span"!==e.target.tagName.toLowerCase())return;let t=e.target.dataset.name;this.disabled||"pipe"===t||(this.addon[t]?this.addon[t].call(this,e.target):console.log("%c没有对应的插件%c[%s]","color:#f00;","",t))},compile:function(){let e=this.value.trim();this.props.safeMode&&(e=e.replace(/<script([^>]*?)>/g,"&lt;script$1&gt;").replace(/<\/script>/g,"&lt;/script&gt;")),this.__tmp__=marked(e),this.props.revise&&(this.__tmp__=this.props.revise(this.__tmp__))}}});